# cloudbuild.yaml
steps:
  # 1) Docker ì´ë¯¸ì§€ ë¹Œë“œ
  - name: gcr.io/cloud-builders/docker
    args:
      [
        "build",
        "-t",
        "gcr.io/$PROJECT_ID/ai-backend",
        "."
      ]

  # 2) ë¹Œë“œí•œ ì´ë¯¸ì§€ë¥¼ Google Container Registry (GCR)ì— í‘¸ì‹œ
  - name: gcr.io/cloud-builders/docker
    args:
      [
        "push",
        "gcr.io/$PROJECT_ID/ai-backend"
      ]

  # 3) Cloud Run ë°°í¬
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      [
        "run",
        "deploy",
        "ai-backend-service", # ğŸ’¡ ë°°í¬í•  ì„œë¹„ìŠ¤ ì´ë¦„
        "--image",
        "gcr.io/$PROJECT_ID/ai-backend",
        "--region",
        "asia-northeast3", # ğŸ’¡ GCP ë¦¬ì „ (ì˜ˆ: ì„œìš¸)
        "--platform",
        "managed",
        "--allow-unauthenticated",
        "--port",
        "8080"
        # ğŸ’¡ [ì¤‘ìš”] .envì— ìˆëŠ” í™˜ê²½ë³€ìˆ˜ëŠ” ì—¬ê¸°ì— --set-env-varsë¡œ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
        # ì˜ˆ: "--set-env-vars", "DB_HOST=..., USER=..., PASSWORD=..., CHATBOT_API_KEY=..."
      ]

images:
  - gcr.io/$PROJECT_ID/ai-backend
